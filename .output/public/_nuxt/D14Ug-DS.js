import{_ as G}from"./Br3K3lNa.js";import{C as O,k as J,r as u,j as L,D as K,G as Q,l as W,H as M,I as X,c as a,a as t,b as Y,w as Z,p as g,s as S,t as h,F as ee,n as te,q as se,m as oe,x as re,o as n,d as ae,z as ne}from"./AkD5g4Ve.js";import{u as le}from"./6njsMXsu.js";const ie={class:"container mx-auto px-4 py-8"},de={class:"bg-glass-light dark:bg-glass-dark backdrop-blur-md rounded-xl shadow-glass overflow-hidden"},ue={class:"p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between"},ce={class:"flex items-center"},ge={key:0,class:"flex items-center"},fe={class:"relative"},ve=["src"],me={class:"ml-3"},he={class:"text-lg font-semibold text-gray-800 dark:text-white"},pe={class:"text-xs text-gray-500 dark:text-gray-400"},ye={key:1,class:"flex items-center"},xe={key:0,class:"flex justify-center py-4"},_e={key:1,class:"flex flex-col items-center justify-center h-full text-gray-500 dark:text-gray-400"},be={key:2,class:"space-y-4"},we=["onClick"],ke={key:0,class:"ml-1"},Me={class:"p-4 border-t border-gray-200 dark:border-gray-700"},Se=["disabled"],Ce=["disabled"],De={__name:"[id]",setup(Fe){var T;const D=Q(),p=O(),{user:C}=J(),l=u((T=C.value)==null?void 0:T._id);L(()=>C.value,e=>{e&&e._id&&(console.log("User updated, setting userId to:",e._id),l.value=e._id)});const{getChatMessages:j,sendMessage:B,getProfilePictureUrl:N,getFriendsList:P}=le(),{onlineFriends:f,messages:$,sendPrivateMessage:A,setCurrentChat:F}=K(),i=u(D.params.id),r=u(null),y=u([]),v=u(""),_=u(!0),m=u(null),I=u(!0);console.log("Current user ID:",l.value),W(async()=>{console.log("Component mounted, userId:",l.value),i.value&&(await H(),await V(),F(i.value))}),L(()=>$.value.get(i.value),e=>{e&&(y.value=[...e],R())},{deep:!0});async function H(){try{const s=(await P()).find(d=>d._id===i.value);s?r.value=s:(p.error("Friend not found"),console.error("Friend not found in friends list"))}catch(e){p.error("Failed to load friend profile"),console.error(e)}}async function V(){_.value=!0;try{const e=await j(i.value);console.log("Messages from API:",e),e&&e.length>0&&(console.log("First message:",e[0]),console.log("First message sender:",e[0].sender),console.log("First message sender type:",typeof e[0].sender),console.log("userId type:",typeof l.value),console.log("userId === first message sender?",l.value===e[0].sender)),y.value=e,await M(),b()}catch(e){p.error("Failed to load chat messages"),console.error(e)}finally{_.value=!1}}async function z(){if(!v.value.trim()||!i.value)return;const e=v.value;v.value="";try{A(i.value,e)||await B(i.value,e),await M(),b()}catch(s){p.error("Failed to send message"),console.error(s)}}function q(e){return e?new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):""}function E(e){if(!e)return"a while ago";const s=new Date(e),o=new Date-s,c=Math.floor(o/6e4);if(c<1)return"just now";if(c<60)return`${c} minute${c===1?"":"s"} ago`;const x=Math.floor(c/60);if(x<24)return`${x} hour${x===1?"":"s"} ago`;const k=Math.floor(x/24);return k<7?`${k} day${k===1?"":"s"} ago`:s.toLocaleDateString()}function b(){m.value&&(m.value.scrollTop=m.value.scrollHeight)}function R(){I.value&&M(()=>{b()})}function U(){if(m.value){const{scrollTop:e,scrollHeight:s,clientHeight:d}=m.value;I.value=e+d>=s-10}}function w(e){const s=String(l.value),d=String(e.sender);return s===d}return X(()=>{F(null)}),(e,s)=>{const d=G;return n(),a("div",ie,[t("div",de,[t("div",ue,[t("div",ce,[Y(d,{to:"/friends",class:"mr-4 text-gray-600 dark:text-gray-300 hover:text-primary-600 dark:hover:text-primary-400"},{default:Z(()=>s[1]||(s[1]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10 19l-7-7m0 0l7-7m-7 7h18"})],-1)])),_:1,__:[1]}),r.value?(n(),a("div",ge,[t("div",fe,[t("img",{src:g(N)(r.value),alt:"Profile",class:"w-10 h-10 rounded-full object-cover"},null,8,ve),t("span",{class:S(["absolute bottom-0 right-0 w-3 h-3 rounded-full",{"bg-green-500":g(f).get(r.value._id)==="online","bg-yellow-500":g(f).get(r.value._id)==="away","bg-gray-500":!g(f).get(r.value._id)||g(f).get(r.value._id)==="offline"}])},null,2)]),t("div",me,[t("h2",he,h(r.value.username),1),t("p",pe,h(g(f).get(r.value._id)==="online"?"Online":g(f).get(r.value._id)==="away"?"Away":"Last seen "+E(r.value.lastSeen)),1)])])):(n(),a("div",ye,s[2]||(s[2]=[t("div",{class:"h-10 w-10 rounded-full bg-gray-200 dark:bg-gray-700 animate-pulse"},null,-1),t("div",{class:"ml-3"},[t("div",{class:"h-5 w-24 bg-gray-200 dark:bg-gray-700 rounded animate-pulse"}),t("div",{class:"h-3 w-16 bg-gray-200 dark:bg-gray-700 rounded mt-1 animate-pulse"})],-1)])))])]),t("div",{ref_key:"messagesContainer",ref:m,class:"p-4 h-[calc(100vh-250px)] sm:h-[calc(100vh-220px)] md:h-[calc(100vh-200px)] overflow-y-auto",onScroll:U},[_.value?(n(),a("div",xe,s[3]||(s[3]=[t("div",{class:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"},null,-1)]))):y.value.length===0?(n(),a("div",_e,s[4]||(s[4]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-12 w-12 mb-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})],-1),t("p",null,"No messages yet. Start the conversation!",-1)]))):(n(),a("div",be,[(n(!0),a(ee,null,te(y.value,(o,c)=>(n(),a("div",{key:o._id||c,onClick:()=>console.log("Message:",o,"Sender:",o.sender,"userId:",l.value.value,"Equal?",o.sender===l.value.value),class:S(["max-w-[90%] sm:max-w-[75%] rounded-lg p-2 sm:p-3 text-sm sm:text-base",w(o)?"ml-auto bg-primary-600 text-white rounded-br-none":"bg-white dark:bg-gray-700 text-gray-800 dark:text-white rounded-bl-none"])},[t("p",null,h(o.content),1),t("p",{class:S(["text-xs mt-1",w(o)?"text-primary-200":"text-gray-500 dark:text-gray-400"])},[ae(h(q(o.createdAt))+" ",1),w(o)?(n(),a("span",ke,h(o.read?"â€¢ Read":""),1)):ne("",!0)],2)],10,we))),128))]))],544),t("div",Me,[t("form",{onSubmit:se(z,["prevent"]),class:"flex items-center"},[oe(t("input",{"onUpdate:modelValue":s[0]||(s[0]=o=>v.value=o),type:"text",placeholder:"Type a message...",class:"flex-1 px-3 sm:px-4 py-2 text-sm sm:text-base bg-white/70 dark:bg-gray-800/70 border border-gray-300 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-600 dark:focus:ring-primary-500",disabled:!r.value},null,8,Se),[[re,v.value]]),t("button",{type:"submit",class:"ml-2 px-3 sm:px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg transition-colors text-sm sm:text-base",disabled:!v.value.trim()||!r.value}," Send ",8,Ce)],32)])])])}}};export{De as default};
